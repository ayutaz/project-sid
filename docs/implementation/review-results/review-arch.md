# アーキテクチャ・ロードマップ レビュー

## エグゼクティブサマリー

レビュー対象の3ドキュメント（00-overview.md、01-system-architecture.md、roadmap.md）は、全体として**高品質**であり、PIANOアーキテクチャの核心的な設計思想を正確に反映している。特に01-system-architecture.mdの技術的深度は優れており、SAS設計、モジュールスケジューラ、並行アクセス制御の設計は論文の要件を忠実に再現実装するための堅実な基盤を提供している。

しかし、以下の重要な課題が存在する:

1. **論文のCCアーキテクチャの微妙な誤解**: CCを「全モジュール出力を読み取り→決定→ブロードキャスト」という単純なフローで記述しているが、論文のGWTモデルでは情報の**競合的選択（competitive selection）**プロセスがより重要であり、この点が設計に十分反映されていない
2. **ティックベーススケジューリングの論文からの逸脱**: 論文は各モジュールが「自分のペースで」非同期に動作することを強調しているが、01-system-architecture.mdの設計は同期的なティック駆動に偏っている
3. **ロードマップのコスト見積もりと開発規模の楽観性**: Phase 0のMVPで2-3ヶ月/2-3人は妥当だが、Phase 1以降の工数が過小評価されている可能性が高い
4. **スケーリング戦略の段階的移行が不明確**: 10体→50体→500体のアーキテクチャ移行パスが具体性を欠く

全体評価: **B+**（良好。主要な方向性は正しいが、上記の課題を解消することで実装の成功確率が大幅に向上する）

---

## レビュー対象

- `00-overview.md` — 全体概要、ドキュメント構成、技術スタック、主要判断
- `01-system-architecture.md` — PIANO全体設計、SAS、モジュール間通信、技術選定
- `roadmap.md` — フェーズ別ロードマップ（Phase 0-3、9-13ヶ月）

## 参照元

- `docs/index.md` — 論文分析トップページ
- `docs/02-piano-architecture.md` — PIANOアーキテクチャの論文分析

---

## 詳細レビュー

### 1. 論文との整合性

#### 1.1 正確に反映されている点

- **並行性と一貫性の二大課題**: 論文Section 2の2つの根本的課題（Concurrency / Coherence）が正確に認識され、設計全体の柱となっている
- **ステートレスモジュール設計**: 論文Section 2.6の「各モジュールをステートレスな操作として設計し、共有状態を介して間接的に通信」が`PianoModule`基底クラスとして忠実に実装されている
- **GWT（Global Workspace Theory）との対応**: CCのボトルネック+ブロードキャスト設計がGWTの設計思想を反映している
- **記憶の三層構造**: WM/STM/LTMの区分が論文Section 2.3に準拠している
- **モジュール速度区分**: Fast/Mid/Slow/Selectiveの4区分が論文の記述と一致している

#### 1.2 不正確または不十分な点

**[重要] CCの情報ボトルネックにおける「競合的選択」の欠落**

論文のGWT（Global Workspace Theory）では、複数のモジュールからの情報が**競合的に注意を獲得する**プロセスが中核にある。現在の設計（01-system-architecture.md:141-145）では:

```
Phase 3: 認知コントローラ (Cognitive Controller)
  CC が SAS から全モジュール出力を読み取り
  → 情報ボトルネック: 重要情報を選択・圧縮
  → 高レベル意思決定を生成
```

これは「全モジュール出力を単純に読み取って圧縮する」という受動的なモデルであり、GWTの「モジュール間の競合→最も顕著な情報の選択→グローバルワークスペースへのアクセス獲得→ブロードキャスト」という動的プロセスを十分に表現していない。

**推奨**: CCの設計に「salience scoring（顕著性スコアリング）」を導入し、各モジュール出力が注意を競合的に獲得するメカニズムを明示化すべき。これはDoc03（認知コントローラ実装方針）で扱われるべき内容だが、01-system-architecture.mdの全体設計レベルでもこの概念を反映すべきである。

**[中] モジュール実行の非同期性の過小評価**

論文Section 2.2は、各モジュールが「**異なる速度で並列実行**」されることを強調している。しかし01-system-architecture.mdのスケジューラ設計（`run_tick`メソッド、行575-646）は、基本的に**同期ティック駆動**であり:

- 高速モジュールを`asyncio.gather`で同期的に待機（行615-621）
- 低速モジュールをバックグラウンドタスクとして起動するが、次ティックの冒頭で結果回収を試みる（行596-602）
- CC実行がティック内で同期的に行われる（行629-633）

論文の意図は、各モジュールが本当に**独立したタイミング**で実行されることであり、「共通ティックに同期させて実行する」設計は論文の思想からやや逸脱している。特にCCが「毎4ティック（200ms）」という短い間隔で設計されている点は、論文のCC実行間隔（review-integrationでも指摘されている1-15秒の範囲）と大きく乖離する。

**推奨**: ティックベースの同期スケジューリングではなく、各モジュールが独立した`asyncio.Task`として自律的に実行され、共有状態を介して間接的に連携するイベントループ型の設計を検討すべき。ティックはMinecraftのゲームティックとの同期用に限定し、モジュールスケジューリングとは分離する。

**[低] 非LLMモジュールの具体性不足**

論文Section 2.2で「小規模な非LLMニューラルネットワーク」と記述されているAction Awarenessモジュールについて、01-system-architecture.mdでは`ActionResultComparator()`という抽象的なクラスを使っているが、このNNの具体的なアーキテクチャ（入力特徴量、モデル構造、学習データの取得方法）が本ドキュメントの範囲では不明。Doc07で詳細化されているが、01の全体設計としても「NNの学習パイプラインをどう組み込むか」の概要が欲しい。

---

### 2. 技術的妥当性

#### 2.1 優れている点

**SASの設計が堅実**

- Redisを共有状態ストアとして選択し、楽観的並行制御+Luaスクリプトによるアトミックなcheck-and-setを実装している点は技術的に妥当
- セクション単位の読み書きとバージョニングにより、モジュール間の書き込み衝突が稀であるという正しい分析に基づいている
- `read_snapshot`でRedis pipelineを使用した原子的な複数セクション読み取りも適切

**技術スタックの選定が現実的**

- Python 3.12+ / asyncio / Redis / Ray / LiteLLMの組み合わせは、LLMエージェント開発の現在のベストプラクティスに沿っている
- 代替案（TypeScript全面採用、Rust、Go）との比較が根拠付きで記述されている

**三層永続化（Redis→PostgreSQL→Object Storage）が適切**

- ホットデータ（SAS）のRedis配置、永続化のPostgreSQL、アーカイブのS3/MinIOという階層設計は、データのアクセスパターンに適合している

#### 2.2 技術的懸念

**[重要] Redis pipelineは原子的ではない**

01-system-architecture.mdの`read_snapshot`メソッド（行366-379）のコメントで「Redis pipeline で原子的に取得」と記述されているが、これは**不正確**。Redis pipelineはバッチ実行であり、各コマンド間に他のクライアントの操作が挟まる可能性がある。真に原子的なスナップショットが必要な場合は、`MULTI/EXEC`（トランザクション）またはLuaスクリプトでの一括読み取りが必要。

CCが全セクションを一貫して読み取る必要がある場合、pipeline方式では読み取り中にモジュールが一部セクションを更新し、不整合なスナップショットを取得するリスクがある。ただし、実用上は各セクションが異なるモジュールにより異なるタイミングで更新されるため、完全な一貫性が必要かどうかは要検討。

**推奨**: CCのスナップショット読み取りについて:
1. 厳密な一貫性が必要 → Luaスクリプトでの一括読み取りに変更
2. 最終的一貫性で十分 → 現在のpipeline方式を維持し、コメントを修正

**[中] 楽観的ロックの衝突時リトライ戦略が未定義**

`write_section`の楽観的ロック（行341-364）で衝突が検出された場合の再試行ロジックが呼び出し側に委ねられているが、具体的なリトライ戦略（最大リトライ回数、バックオフ、衝突頻度の監視）が未定義。モジュール実装者に適切なリトライ実装を要求するのであれば、ベースクラスレベルでリトライラッパーを提供すべき。

**[中] LLMCallOptimizerのキャッシュ戦略が単純すぎる**

行836-862のキャッシュ実装は`hash(prompt)`による完全一致キャッシュであるが:
- メモリ管理（キャッシュサイズ上限、TTL）が未実装
- エージェント固有の文脈を含むプロンプトは完全一致ヒットが極めて稀
- review-cost.mdでも指摘されているように、セマンティックキャッシュのヒット率は楽観的すぎる

**推奨**: 完全一致キャッシュはあくまでスタブとして位置づけ、本格的なキャッシュ戦略はDoc02（LLM統合戦略）に委譲する旨を明記すべき。

**[低] Minecraftティック（50ms）との同期の現実性**

MODULE_TICK_CONFIG（行661-671）でAction Awarenessが「毎ティック = 50ms」と設定されているが、LLMを使わないNNベースのモジュールであっても、Redisとの往復（読み取り→処理→書き込み）を50msで完了するにはネットワークレイテンシとNN推論時間の両方を考慮する必要がある。ローカルRedis（RTT < 1ms）かつ軽量NNであれば可能だが、分散環境では困難。

---

### 3. ロードマップの現実性

#### 3.1 フェーズ分けの評価

**Phase 0 (MVP): 妥当**
- 2-3ヶ月 / 2-3人 / $50-100/月は現実的
- SAS + スケジューラ + CC MVP + Memory(WM+STM) + Skill Execution + Action Awareness(ルールベース)という構成は、論文のベースライン構成（Memory + Skill Execution + CC）をカバーしつつ、最小限の追加（Action Awareness）を含む適切な範囲
- ただし、Python-Mineflayerブリッジの技術PoCがW4に含まれているが、これがPhase 0の最大リスクであり、**W1-W2で先行PoCを実施すべき**

**Phase 1 (基盤完成): やや楽観的**
- 3-4ヶ月 / 3-5人で12個の成果物（1-1〜1-12）は密度が高い
- 特に「行動認識NN（~100Kパラメータ）」(1-7)の学習パイプライン構築は、Minecraft操作ログの収集→ラベリング→学習→検証のサイクルが必要であり、単独で1-2ヶ月かかる可能性がある
- 「社会認知精度 r>0.7 を達成」(W16)は、50体の長時間実験が必要であり、Phase 2のスケーリング基盤なしに達成困難

**Phase 2 (スケーリング): 依存関係に懸念**
- Ray分散実行基盤(2-1)とVelocity MCプロキシ(2-3)の同時構築は、それぞれ異なるスキルセットを要求するため、2-3人での並列開発が現実的かどうか疑問
- 「500体が4時間安定動作」(W12)の達成基準は非常に高い。論文でも「1000+でサーバー限界」と言及されており、500体での安定動作自体がスケーリングの難所

**Phase 3 (文明実験): コスト面で最大のリスク**
- 月額$44,600-84,600は、論文再現のための実験コストとして非常に高額
- 「全論文実験の再現完了」(W12)は、各実験の複数回繰り返し（論文では各条件4回）を考慮すると、2-3ヶ月では不足の可能性

#### 3.2 依存関係の問題点

**クリティカルパスの過小評価**

ロードマップのクリティカルパス図は線形的に描かれているが、実際には以下の暗黙的な依存関係がある:

1. **SASスキーマのフリーズ**: 全モジュールがSASに依存するため、スキーマ変更が全モジュールに波及する。しかしフリーズポイントが未定義（review-integrationでも指摘）
2. **LLMプロンプトの反復改善**: CCやGoal Generationのプロンプトは一度で完成せず、実験→分析→修正のサイクルが複数回必要。これがPhase 1の期間を延伸させる最大の要因
3. **Mineflayerスキルの蓄積**: Skill Executionのスキルライブラリは段階的に拡充する必要があるが、各スキルのデバッグ工数が過小評価されている

**Phase間の移行コストが無視されている**

- Phase 0のローカルDocker Compose → Phase 2のKubernetesへの移行は、設定のリファクタリング、デプロイパイプラインの再構築、パフォーマンステストの再実施を要する
- この移行コスト（2-4週間）がロードマップに含まれていない

---

### 4. 完全性

#### 4.1 欠落している要素

**[重要] エージェント間通信の設計が不十分**

01-system-architecture.mdはエージェント**内部**のモジュール間通信に焦点を当てているが、エージェント**間**の通信（会話、観察、社会的相互作用）の設計が薄い。論文のマルチエージェント実験（50体社会、500体文明実験）では、エージェント間の直接的な相互作用が核心であり:

- エージェントAが発話 → エージェントBの知覚に反映されるまでのデータフロー
- 同一空間内の複数エージェントの観察可能範囲（知覚半径）
- エージェント間のメッセージングプロトコル（同期 vs 非同期）

これらの設計が01-system-architectureに含まれるべき。

**[重要] 障害復旧・状態回復の設計がない**

- エージェントプロセスがクラッシュした場合のSAS回復手順
- Redis障害時のフォールバック戦略
- 長時間実験中のチェックポイント・リスタートメカニズム

500体が4時間動作する実験では、少なくとも一部のエージェントやインフラコンポーネントに障害が発生する確率は無視できない。

**[中] エージェントの初期化・性格付けの設計がない**

論文の実験では、エージェントに性格特性（Big Five）や初期記憶（村落インフラの位置など）を付与している。しかしこれらの初期化フローの設計が01-system-architecture.mdに含まれていない。

**[中] シミュレーション時間と実時間の対応が未定義**

論文では「30分」「4時間」「2.5時間」等の実験時間が記載されているが、これがゲーム内時間なのか実時間なのか、また1エージェントティックが実時間でどの程度に相当するのかの明確な定義がない。

#### 4.2 roadmap.mdにおける欠落

**技術的負債の管理計画がない**

Phase 0のMVP（ルールベースAction Awareness、WM+STMのみ、固定テンプレートCC）から Phase 1の本格実装への移行時に、MVP段階の仮実装を置き換える作業が必要。この「技術的負債の返済」スケジュールがロードマップに含まれていない。

**人員のオンボーディング・スキル習得期間がない**

ロードマップでは「ピーク5人」の人員を想定しているが、PIANOアーキテクチャと論文の理解、コードベースへの習熟に必要な時間が計上されていない。

---

### 5. 明確性

#### 5.1 曖昧な記述

**「約10個の専門化されたモジュール」**

00-overview.mdと01-system-architecture.mdで「約10個」と記載されているが、01のモジュール一覧（行112-122）は9個を列挙している。論文でも正確な数は明示されていないため「約10個」は論文準拠ではあるが、実装設計としては確定的なモジュール一覧が必要。

**CCの「情報圧縮」の具体性不足**

01-system-architecture.md:143で「情報ボトルネック: 重要情報を選択・圧縮」と記載されているが、「選択」と「圧縮」の具体的なアルゴリズム（重要度のスコアリング基準、圧縮のフォーマット）は本ドキュメントの範囲では不明。Doc03に委譲されていることは理解できるが、01の全体設計として「CCへの入力情報量の上限」「ブロードキャストメッセージの構造」程度は明記すべき。

**「高速」「低速」の定量的定義**

モジュール速度区分のFast/Mid/Slow/Selectiveの境界が定量的に定義されていない。MODULE_TICK_CONFIG（行661-671）で具体的な数値が記載されているが、これが「速度区分の定義」なのか「初期パラメータ」なのかが不明確。

#### 5.2 未定義の用語

- **「ActionResultComparator」** (行509): クラス名のみで、このコンパレータが何を比較するのか（インベントリの差分? 位置の変化? ブロックの変化?）が不明
- **「activation_condition」** (行445): 文字列型で定義されているが、どのような条件式が使用可能かが未定義（DSL? Python式? Enum?）

---

### 6. 技術選定

#### 6.1 適切な選定

| 技術 | 評価 | 根拠 |
|---|---|---|
| Python 3.12+ | 適切 | LLMエコシステム最大、asyncioの成熟度 |
| Redis 7+ | 適切 | SASの要件（低レイテンシ読み書き、Pub/Sub、Luaスクリプティング）に最適 |
| PostgreSQL 16 | 適切 | 永続化層として信頼性・機能性ともに十分 |
| LiteLLM | 適切 | マルチプロバイダ対応の標準的選択 |
| Docker + Kubernetes | 適切 | 段階的スケーリング（Compose→K8s）に対応 |

#### 6.2 要検討の選定

**Ray 2.x — 適切だが導入タイミングに懸念**

Rayはマルチエージェント分散実行に適しているが、Phase 0-1のローカル開発段階から導入すると学習コストとデバッグの複雑性が増す。Phase 0-1は純粋なasyncio（マルチプロセスは`multiprocessing`）で開発し、Phase 2でRayに移行する戦略を明確にすべき。

**Qdrant — 適切だが本番導入はPhase 1以降**

LTMのベクトルDBとしてQdrantの選定は技術的に妥当（payload-aware HNSW、バイナリ量子化）。ただし、Phase 0ではLTMを実装しないため、Qdrantの導入はPhase 1以降で十分。review-integrationで指摘されている開発環境でのpgvector使用も合理的。

**Pufferfish + Velocity — 情報の不十分さ**

Pufferfishは高性能MCサーバーとして推奨されているが:
- Pufferfishの開発状況（アクティブメンテナンスか、最新MCバージョン対応か）の検証が不足
- Velocityプロキシの設定例や、エージェント接続の分散方法の具体的設計がない
- Dockerイメージの入手可能性（公式イメージの有無、カスタムビルドの必要性）が未確認

**推奨**: Pufferfishの現在の開発状況をWeb検索等で確認し、メンテナンス停止リスクがある場合はPaper + 最適化設定での代替プランを用意すべき。

#### 6.3 欠落している技術選定の検討

**テスト・品質保証ツール**

01-system-architecture.mdおよびroadmap.mdで、テストフレームワークの選定（pytest, unittest, hypothesis）、カバレッジツール、静的解析ツール（mypy, ruff）の記述がない。review-testingで扱われているが、全体アーキテクチャ文書にも概要を含めるべき。

**構成管理**

Hydra + Pydantic v2の組み合わせは00-overview.mdで言及されているが、01-system-architecture.mdには含まれていない。各モジュールの設定パラメータ（ティック間隔、LLMモデル選択、SASセクション定義等）の管理方法が全体設計から欠落している。

---

## 問題点リスト（優先度付き）

| # | 優先度 | 対象ファイル | 問題の概要 | 推奨対応 |
|---|--------|-------------|-----------|---------|
| 1 | Critical | 01-system-architecture.md | Redis pipelineを「原子的」と記述しているが不正確。CCのスナップショット読み取りで不整合データを取得するリスクがある | Luaスクリプトでの一括読み取りに変更するか、最終的一貫性で十分な旨をコメント修正 |
| 2 | Critical | 01-system-architecture.md | CCの情報ボトルネックにおけるGWTの「競合的選択」プロセスが設計に反映されていない | salience scoringメカニズムの概念設計を追加 |
| 3 | High | 01-system-architecture.md | モジュールスケジューラが同期的ティック駆動に偏っており、論文の「各モジュールが独立した速度で実行」という思想からの逸脱 | モジュール独立実行+共有状態ベースの間接連携設計への変更を検討 |
| 4 | High | 01-system-architecture.md | エージェント間通信の設計が欠落（内部モジュール通信のみ記述） | エージェント間のメッセージング・観察・知覚共有の設計セクションを追加 |
| 5 | High | roadmap.md | Phase 1の「社会認知精度 r>0.7」はPhase 2のスケーリング基盤なしに達成困難 | 成功基準をPhaseの能力に合わせて再調整 |
| 6 | High | 01-system-architecture.md | 障害復旧・チェックポイント・状態回復の設計が完全に欠落 | 新セクション「障害復旧設計」を追加 |
| 7 | Medium | 01-system-architecture.md | 楽観的ロックの衝突時リトライ戦略が未定義 | PianoModule基底クラスにリトライラッパーを追加、または設計指針を明記 |
| 8 | Medium | roadmap.md | Phase間の移行コスト（Docker Compose→K8s等）がロードマップに計上されていない | 各Phase間に1-2週間の移行期間を追加 |
| 9 | Medium | roadmap.md | 技術的負債の管理計画がない（MVP仮実装→本格実装の置換スケジュール） | Phase 1の初期に「MVP負債返済」マイルストーンを追加 |
| 10 | Medium | 00-overview.md | 「未解決事項」3件の決定プロセスと期限が未定義 | 各項目にPoCの実施方法と判断期限を追記 |
| 11 | Medium | 01-system-architecture.md | MODULE_TICK_CONFIGの数値（特にCC=200ms）がDoc03の1-15秒と大幅に矛盾 | review-integrationの指摘に従い統一 |
| 12 | Medium | 01-system-architecture.md | エージェント初期化（性格付け、初期記憶）の設計が欠落 | AgentFactory/AgentInitializerの概要設計を追加 |
| 13 | Low | 01-system-architecture.md | LLMCallOptimizerのキャッシュがメモリ管理なし（サイズ上限、TTL未実装） | キャッシュ戦略はDoc02に委譲する旨を明記 |
| 14 | Low | roadmap.md | 人員のオンボーディング期間が計上されていない | Phase 0開始前に2週間のオンボーディング期間を追加 |
| 15 | Low | 00-overview.md | ドキュメント構成にTalkingモジュール専用の設計書が欠落 | review-integrationと同様、追加ドキュメントとして言及 |

---

## 推奨事項

### 即座に対応すべき事項（Phase 0開始前）

1. **01-system-architecture.mdのRedis pipelineの記述を修正**: 「原子的」→「バッチ実行（完全な原子性は保証されない）」に修正し、CCの読み取り一貫性要件を明確化する

2. **CC実行間隔の統一**: MODULE_TICK_CONFIGのCC=200ms（4ティック）を削除し、Doc03の動的スケジューリング（1-15秒）への参照に置き換える

3. **エージェント間通信セクションの追加**: 01-system-architecture.mdに「エージェント間通信」セクションを追加し、Redis Pub/Sub or 共有知覚空間のデータモデルを設計する

### Phase 0中に対応すべき事項

4. **Python-Mineflayerブリッジの早期PoC**: roadmap.mdのW4ではなくW1-W2で実施。ブリッジの性能がシステム全体のボトルネックとなる可能性が高いため、最優先で技術検証すべき

5. **SASスキーマv0.1の策定とフリーズ**: Phase 0の成果物リストに「SASスキーマ定義書」を追加。全モジュールのread/writeセクションを一覧化したマッピング表を作成する

6. **障害復旧設計の追加**: エージェントクラッシュ時のSAS回復、Redis障害時のフォールバック、長時間実験のチェックポイント/リスタートを設計する

### 中期的に対応すべき事項

7. **モジュールスケジューラの再設計検討**: 同期ティック駆動から、モジュール独立実行型への段階的移行を計画する。Phase 0ではシンプルなティック駆動で開始し、Phase 1で独立実行型に移行するロードマップを追加

8. **ロードマップの成功基準を再調整**: 特にPhase 1の「社会認知精度 r>0.7」は50体実験に依存するため、Phase 1では10体での基本動作検証に限定し、50体での定量評価はPhase 2に移動

9. **Pufferfishの開発状況・メンテナンス状態の確認**: 公式リポジトリの最新コミット日、MCバージョン対応状況、コミュニティの活発さを確認し、リスクが高い場合はPaper + 最適化設定への代替プランを策定
