# プラットフォーム・インフラ レビュー

## エグゼクティブサマリー

3つのドキュメント（05-minecraft-platform.md、08-infrastructure.md、10-devops.md）は全体として**高品質**であり、Project Sidの再現実装に必要なプラットフォーム・インフラ設計を包括的にカバーしている。特にMinecraft基盤技術の選定理由、段階的スケーリング戦略、コスト見積もりは具体的で現実的である。

しかし、以下の主要な問題点が特定された:

1. **ドキュメント間の設定値不整合**: view-distance、サーバータイプ（Paper vs Pufferfish）、メモリ見積もりなどが3ドキュメント間で矛盾
2. **論文の実験環境との一部乖離**: 論文の6町配置（各33体）と農村302体の構成が、インフラ設計のシャーディングと完全には一致していない
3. **Pufferfishサーバーのリスク評価不足**: Pufferfishはアクティブに維持されているが、Paper本体と比較してコミュニティ規模が小さく、依存リスクの明記が不十分
4. **Redis Pub/Subのスループット主張に根拠不足**: 「チャンネルあたり6K msg/sec」の数値の出典が不明
5. **DevOpsドキュメントでのMinecraftサーバー設定がプラットフォームドキュメントと矛盾**

全体評価: **B+** (良好だが、整合性の改善とリスク評価の追加が必要)

## レビュー対象

- 05-minecraft-platform.md
- 08-infrastructure.md
- 10-devops.md

## 詳細レビュー

### 1. 論文との整合性

#### 良い点

- 論文の全実験一覧（06-methods.md Table）が正確に反映されている
- 500体実験の環境サイズ（1000x1200ブロック）、6つの町（各33体）、農村302体の構成が08-infrastructure.mdのシャーディング設計に反映
- PIANOアーキテクチャの9モジュール構成がインフラ設計に正確に反映（08-infrastructure.md 8.2節）
- 論文のモジュール実行頻度（CC 1-15秒の動的間隔、目標生成5-10秒）がリソース計算に反映

#### 問題点

**P1: シャーディング設計と論文の町構成の不一致**

08-infrastructure.md 8.4節では6シャードに各83体の町エージェント+50体の農村エージェントを配置する設計だが、論文では各町33体（合計198体、農村302体）である。シャーディング設計では各シャードの町エージェント数が83体に膨らんでおり、論文の構成と一致しない。

具体的には:
- 論文: 6町 x 33体 = 198体（町）+ 302体（農村）= 500体
- 08-infrastructure.md: 6シャード x (83体町 + 50体農村) = 498体町 + 302体農村 = 800体

83体は500体を6で割った数であり、町エージェントと農村エージェントを区別せずにシャーディングした数値と思われる。しかしラベルが「町エージェント」となっている点が混乱を招く。

**P2: 集団ルール実験の構成員数の表記**

論文（05-civilization.md）では29体（構成員25 + インフルエンサー3 + 選挙管理者1）と明記されているが、スケーリングロードマップ（05-minecraft-platform.md 6.4節）のPhase 2は25体となっており、29体をカバーしていない。

**P3: Minecraft Serverバージョン**

05-minecraft-platform.md ではMinecraft 1.20.4を前提としているが、Pufferfishは既に1.21.xに対応済み。バージョン選定の根拠（1.20.4固定の理由）が明記されていない。

### 2. Minecraft基盤

#### 良い点

- Mineflayerの技術分析は非常に詳細で正確。API一覧、イベントシステム、プラグインエコシステムの記述は公式ドキュメントと一致
- pathfinderプラグインのGoalTypesの列挙が網羅的
- Voyager等の既存プロジェクトとの比較表が有用で、再現実装への示唆が具体的
- Mineflayerの制約（メモリ消費、シングルスレッド）が正直に記載されている

#### 問題点

**P4: Mineflayerのメモリ見積もりの精度**

05-minecraft-platform.md 2.1節のメモリ見積もり表では:
- 素朴な実装: ~100-200MB/ボット
- 最適化済み: ~15-30MB/ボット

GitHubのMineflayer Discussion #2251によると、50ボットで約5GB（~100MB/ボット）という報告があり、「素朴な実装」の見積もりは妥当。しかし「最適化済み」の15-30MB/ボットは楽観的すぎる可能性がある。SharedArrayBufferによるワールド状態共有は理論的には可能だが、Mineflayerのアーキテクチャ上、各ボットが独立したprismarine-worldインスタンスを持つため、共有メモリ化は大幅な改修が必要。

**P5: Pufferfishの選定リスク**

Pufferfishはアクティブに開発されており（2025年12月時点で1.21.8対応）、「最適」という評価は概ね正しい。ただし以下のリスクが未記載:

- Pufferfish+（有料版）でないと非同期エンティティトラッキング等の高度な最適化が利用できない
- Paperと比較してコミュニティサイズが小さく、プラグイン互換性の問題が発生した場合のサポートが限定的
- Paper本体の最適化が進み、PufferfishのPaperに対する性能優位性が縮小傾向にある

**P6: サーバー側の500+ボット対応の検証不足**

Pufferfish/Paperが500+の**プレイヤー**（ボット）を処理できるかの具体的なベンチマークや実績データが記載されていない。Velocityは「数千プレイヤー」に対応可能とされているが、これは通常プレイヤー（低頻度のアクション）が前提であり、500体のボットが同時にアクションを実行する場合のTPS影響は不明。

### 3. スケーリング設計

#### 良い点

- 段階的スケーリングロードマップ（Phase 1-6）が非常に良く設計されており、各フェーズの目的が明確
- メモリ最適化手法（viewDistance削減、ワールド状態共有、非アクティブボットの休止）の記載が具体的
- 08-infrastructure.md のリソース要件見積もり（10/50/500/1000体）が詳細で、各コンポーネント別に分かれている
- 空間局所性ベースのシャーディング戦略は論文の町ベースの配置と合致する良いアプローチ
- コスト見積もり（AWS/GCP）が現実的な範囲内

#### 問題点

**P7: Worker 1プロセスあたり250エージェントの根拠**

08-infrastructure.md で「1プロセス = 最大250体」としているが、その根拠が不明確。各エージェントに50-100MBのメモリを仮定すると、250体で12.5-25GBとなり、単一プロセスとしてはかなり大きい。また、asyncioのイベントループが250エージェント x 9モジュール = 2,250の並行タスクを効率的にスケジュールできるかの検証が必要。

**P8: LLM API呼び出しのボトルネック分析不足**

500体で3,000-6,000呼び出し/分、1000体で6,000-12,000呼び出し/分という見積もりがあるが:
- OpenAI GPT-4oのTPMリミット（800K TPM）に対して、500体で2.5M-5M TPM必要と見積もっている点は正しく認識されている
- しかし、この制限をどのようにクリアするかの具体的な戦略（複数アカウント？Enterprise tier？）が不明確
- 「マルチプロバイダー」で分散するとしても、各プロバイダーのレート制限を合算しても1000体のフルスケール実行は困難な可能性がある

**P9: Redis Pub/Subの「6K msg/sec/channel」の根拠**

08-infrastructure.md 8.4節で「Redis単体でチャンネルあたり6K msg/secの制限」と記載されているが、この数値の出典が不明。Redis公式ドキュメントではPub/Subのスループットはハードウェア依存とされており、固定の上限値は公開されていない。ベンチマークでは、条件次第で数万〜数十万msg/secも可能。誤解を招く記述。

### 4. DevOps・CI/CD

#### 良い点

- GitHub Actionsワークフローが段階的ゲート（lint → unit → integration → build → deploy）で設計されており、CI/CDのベストプラクティスに従っている
- モジュール単位のマトリクスビルドによる並列テストが効率的
- LLMモック戦略（CIではモック、nightlyで実API）がコスト意識の高い設計
- ブランチ戦略の`experiment/`ブランチの分離が実験管理に適切
- Helmチャートの設計（Umbrellaチャート + サブチャート）が本番運用に適した構成

#### 問題点

**P10: E2Eテストの`self-hosted`ランナー要件**

nightlyのE2Eテストで`self-hosted`ランナー（GPU付き）を要求しているが、GPUが必要な理由が明確でない。Action Awarenessの小規模NNの推論に使うとしても、5エージェントの10分テストでGPUが必須かは疑問。CPUでの推論で十分な可能性がある。

**P11: Docker Composeの`version`フィールド**

10-devops.md のdocker-compose.yml で`version: "3.9"`を指定しているが、Docker Compose V2では`version`フィールドは廃止（deprecated）されている。削除すべき。

### 5. モニタリング・ロギング

#### 良い点

- Prometheus + Grafana + Lokiのスタック選定は、OSSベースで運用コストを抑えながら十分な可観測性を確保できる適切な選択
- メトリクス体系が包括的（エージェント状態、LLM、通信、インフラ）で、各メトリクスにラベル設計が含まれている
- アラートルールが具体的で、TPS低下、エラー率、レート制限、コスト超過の閾値が現実的
- 構造化ログフォーマットが統一されており、agent_id、module、trace_id等のキーフィールドが含まれている
- OpenTelemetryによる分散トレーシングの計画は、エージェントの認知サイクルのデバッグに非常に有用
- ログ保持ポリシーがコスト効率を考慮して設計されている

#### 問題点

**P12: social_sentiment_scoreのカーディナリティ問題**

モニタリングメトリクス（10-devops.md 3.2節）で`social_sentiment_score`に`["agent_id", "target_agent_id"]`のラベルを付与しているが、1000エージェント環境ではラベルの組み合わせが最大1000x999 = 999,000となり、Prometheusのカーディナリティ爆発を引き起こす。これはPrometheusの主要なアンチパターンであり、設計変更が必須。

**P13: ログ出力量の推定が過小**

10-devops.md 4.3節では500エージェント時のINFOログを~5,000/minと推定しているが、500体 x 10モジュール x （モジュール実行ごとに最低1ログ）を考慮すると、実際にはもっと多くなる可能性がある。CCが2秒間隔 = 30回/min x 500体 = 15,000回/minのCC実行ログだけでこの数字を超える。

**P14: Lokiのスケーリング設計の不足**

Lokiを採用する方針は良いが、500-1000エージェントの大規模環境でのLoki構成（Single Binary vs Microservices mode）、インジェスターのレプリカ数、ストレージバックエンドの設計が記載されていない。大量ログでの性能確保には詳細な設計が必要。

### 6. デプロイメント

#### 良い点

- 環境ティア（ローカル開発 → ステージング → 本番）の分離が明確
- Docker Compose（開発）→ Kubernetes（本番）の段階的移行パスが現実的
- ローカル開発のセットアップ手順がステップバイステップで記載されており、開発者体験に配慮
- ノードプール設計（general/agent/gpu）がワークロード特性に合致
- Volcano/Kueueによるギャングスケジューリングは、全エージェントの同時起動に適切

#### 問題点

**P15: ドキュメント間のMinecraftサーバー設定矛盾**

| 設定項目 | 05-minecraft-platform.md | 10-devops.md Dockerfile | 10-devops.md values-prod.yaml |
|---|---|---|---|
| view-distance | 4 | 8 | 6 |
| simulation-distance | 4 | 6 | 4 |
| サーバータイプ | Pufferfish | Paper/Fabric | 記載なし |
| max-players | 600 | 1100 | 200 |

これらの値が3箇所でそれぞれ異なっており、どれが正しいのか不明。特にview-distanceはボットの帯域幅・メモリ消費に直接影響するため、統一が必要。

**P16: Minecraftブリッジの設計詳細不足**

10-devops.md のDocker構成でminecraft-bridgeコンテナが登場するが、その内部アーキテクチャ（Mineflayer? カスタム? Node.js? Python?）が記載されていない。05-minecraft-platform.mdではMineflayerをNode.jsで直接使う構成を記載しており、ブリッジの役割と位置づけが不明確。

**P17: Terraformによるインフラプロビジョニングの不足**

10-devops.md の推奨技術スタックにTerraformが記載されているが、具体的なリソース定義やモジュール構成の記載がない。Kubernetesクラスター、VPC、IAM等の基盤インフラの構築手順が不足。

**P18: シークレット管理の設計不足**

10-devops.md の推奨技術スタックにExternal Secrets Operatorが記載されているが、LLM APIキー、RCONパスワード、データベース認証情報等のシークレットフローの具体的な設計がない。docker-compose.ymlではRCON_PASSWORDがデフォルト値`changeme`で設定されており、セキュリティ上の懸念がある。

## 問題点リスト（優先度付き）

| # | 優先度 | 対象ファイル | 問題の概要 | 推奨対応 |
|---|--------|-------------|-----------|---------|
| P1 | 高 | 08-infrastructure.md | シャーディング設計と論文の町構成の数値不一致 | シャーディングのラベルと数値を論文の構成（町33体 + 農村）に合わせて修正 |
| P4 | 高 | 05-minecraft-platform.md | 最適化済みメモリ見積もり（15-30MB/ボット）が楽観的 | Mineflayerの共有メモリ化の実現可能性を検証し、見積もりに注記を追加 |
| P8 | 高 | 08-infrastructure.md | LLM APIレート制限のクリア戦略が不明確 | 具体的なプロバイダーのTier/アカウント構成、必要なレート制限引き上げ申請について記載 |
| P12 | 高 | 10-devops.md | social_sentiment_scoreのカーディナリティ爆発 | ラベル設計を変更（ヒストグラム集約やサンプリングベースに変更） |
| P15 | 高 | 全ドキュメント | Minecraftサーバー設定の3ドキュメント間矛盾 | 統一された設定値を定義し、環境別（dev/staging/prod）の値を明確化 |
| P5 | 中 | 05-minecraft-platform.md | Pufferfishの選定リスク（有料版依存、コミュニティ規模）が未記載 | リスク表にPufferfish+依存とPaper fallback戦略を追加 |
| P6 | 中 | 05-minecraft-platform.md | 500+ボットのサーバー側TPS影響の検証データなし | Phase 2-3でベンチマークを実施し、結果を反映する計画を追記 |
| P7 | 中 | 08-infrastructure.md | 250エージェント/プロセスの根拠不足 | ベンチマーク計画を記載し、Phase 1-2で実測値を取得する旨を追記 |
| P9 | 中 | 08-infrastructure.md | Redis Pub/Sub 6K msg/sec/channelの根拠不明 | 出典を追加するか、数値を「ハードウェア依存」に修正 |
| P13 | 中 | 10-devops.md | ログ出力量の推定が過小 | モジュール実行頻度ベースでの再計算を実施 |
| P16 | 中 | 10-devops.md | minecraft-bridgeの内部設計が不明確 | ブリッジの役割（MineflayerラッパーかAPIゲートウェイか）を明確化 |
| P2 | 低 | 05-minecraft-platform.md | Phase 2のボット数が論文の集団ルール実験（29体）と不一致 | Phase 2を29体に修正 |
| P3 | 低 | 05-minecraft-platform.md | Minecraftバージョン（1.20.4）の固定理由が不明 | バージョン選定の根拠を追記 |
| P10 | 低 | 10-devops.md | E2Eテストのself-hostedランナーにGPUが本当に必要か不明 | GPU要件を再検討し、不要なら標準ランナーに変更 |
| P11 | 低 | 10-devops.md | docker-compose.ymlのversion フィールドが非推奨 | `version: "3.9"` 行を削除 |
| P14 | 低 | 10-devops.md | Lokiの大規模環境向け構成設計が不足 | Loki Microservicesモードの設計を追記 |
| P17 | 低 | 10-devops.md | Terraformの具体的な構成が不足 | Phase 3以降で必要になるため、ロードマップに明記 |
| P18 | 低 | 10-devops.md | シークレット管理の具体的フロー設計が不足 | External Secrets + AWS Secrets Manager等の具体的なフローを追記 |

## 推奨事項

### 即座に対応すべき事項

1. **設定値の統一ドキュメントを作成**: view-distance、simulation-distance、max-players、サーバータイプ等の設定値を環境別（dev/staging/prod）に一元管理するドキュメントまたは設定テーブルを作成し、3ドキュメントから参照する形にする

2. **social_sentiment_scoreメトリクスの再設計**: エージェントペア単位ではなく、感情スコアのヒストグラム分布（全体のsentiment分布）を記録する方式に変更するか、サンプリングベースでの記録に変更する

3. **LLM APIスケーリング戦略の具体化**: 500-1000体実行時に必要なTPM/RPMを各プロバイダーのTier別に整理し、Enterprise tierの申請やマルチアカウント戦略を明記する

### Phase 0 MVP実装時に検証すべき事項

4. **Mineflayerのメモリ消費実測**: Phase 1（5-10ボット）でボットあたりのメモリ消費を実測し、500体時のリソース計画を更新する。SharedArrayBufferによるワールド状態共有の実現可能性もこの段階で検証する

5. **Pufferfish vs Paper性能比較**: Phase 2で同一条件でのTPS比較ベンチマークを実施し、Pufferfishの性能優位性を定量的に確認する。優位性が確認できない場合はPaperへのフォールバックを検討する

6. **asyncio 250エージェント/プロセスの負荷テスト**: 250エージェント x 9モジュールのasyncioタスクスケジューリングの実効性を検証し、最適なプロセスあたりエージェント数を決定する

### 中長期的な改善事項

7. **minecraft-bridgeの設計ドキュメント追加**: MineflayerとPythonエージェントランタイム間のブリッジ層のアーキテクチャ（通信プロトコル、API設計、状態管理）を詳細化する

8. **Redis Pub/Subの代替評価**: NATS JetStreamを代替候補として評価することを推奨。Redis Pub/Subはメッセージの永続性がなく、サブスクライバーが一時切断するとメッセージを失う。Redis Streamsで補完する設計になっているが、NATSならネイティブにこの問題を解決できる

9. **Terraform/IaCモジュールの設計**: Phase 3（Kubernetes移行）前にクラウドインフラのIaCモジュールを設計し、再現可能なインフラ構築を可能にする

10. **コスト最適化のベンチマーク**: モデルティアリング（高速モジュールにGPT-4o-mini、低速モジュールにGPT-4o）の効果を定量的に検証し、品質低下の許容範囲を確認する
