# セキュリティレビュー

## 概要

本ドキュメントは、Project Sid再現実装の技術調査ドキュメント（01～10）に対するセキュリティ観点のレビュー結果である。PIANOアーキテクチャの再現実装において、500-1000エージェントが並行動作する環境で想定されるセキュリティリスクを分析し、対策を提案する。

---

## 1. リスク一覧（優先度順）

### Critical リスク

| # | リスク | 対象ドキュメント | 詳細 |
|---|---|---|---|
| C-1 | **LLMプロンプトインジェクション（エージェント間）** | 02, 03, 06 | エージェントAの発話がエージェントBのLLMプロンプトに直接挿入される。悪意あるエージェント（または外部チャット入力）が他エージェントの行動を操作可能 |
| C-2 | **APIキーの一元管理不備** | 02, 08, 10 | LLM APIキーがLLMゲートウェイに集中。漏洩時に全エージェントのLLM呼び出しが危殆化。コスト上限なしの場合、膨大な請求リスク |
| C-3 | **共有エージェント状態（SAS）の無認証アクセス** | 01, 08 | RedisベースのSASにアクセス制御が未設計。任意のプロセスがエージェント状態を読み書き可能 |

### High リスク

| # | リスク | 対象ドキュメント | 詳細 |
|---|---|---|---|
| H-1 | **エージェント暴走（無限ループ/リソース枯渇）** | 03, 07 | 行動認識モジュールのハルシネーション検出が不完全な場合、LLM API呼び出しが無限に発生。CC実行間隔の矛盾（01: 200ms, 03: 5秒, 08: 2秒）も不安定要因 |
| H-2 | **Minecraftサーバーへの不正接続** | 05, 08 | Pufferfish/Velocityサーバーがonline-mode=falseで運用される想定。外部からの不正ボット接続が可能 |
| H-3 | **LLM出力の未検証実行** | 05, 07 | Voyager風スキルライブラリがLLM生成コードを実行。コードインジェクションリスク |
| H-4 | **記憶データの汚染** | 04 | ベクトルDB（Qdrant）へのアクセス制御が未設計。記憶の改ざんによりエージェント行動を長期的に操作可能 |

### Medium リスク

| # | リスク | 対象ドキュメント | 詳細 |
|---|---|---|---|
| M-1 | **ログデータの機密性** | 10 | 500-1000エージェントのログにLLMプロンプト/レスポンスが含まれる。Grafana Lokiへのアクセス制御が未設計 |
| M-2 | **実験設定の改ざん** | 10 | Hydra設定ファイルの改ざんにより実験結果が不正操作される可能性 |
| M-3 | **Redis Pub/Subのメッセージ偽装** | 01, 08 | エージェント間通信にメッセージ認証がない。偽のイベントを注入可能 |
| M-4 | **ベクトルDBのスケール攻撃** | 04 | 大量の記憶挿入により1000万ベクトル上限を超過し、サービス拒否 |
| M-5 | **社会グラフの操作** | 06 | NetworkXベースの社会グラフに直接アクセスし、好感度スコアを改ざん可能 |

### Low リスク

| # | リスク | 対象ドキュメント | 詳細 |
|---|---|---|---|
| L-1 | **評価パイプラインのLLM依存** | 09 | GPT-4oによる役割推論・ミーム分析がプロンプトインジェクションの影響を受ける |
| L-2 | **スナップショットデータの保護** | 10 | S3/MinIOに保存されるシミュレーションスナップショットの暗号化が未設計 |
| L-3 | **開発環境と本番環境の分離** | 10 | 環境分離は設計されているが、認証情報の分離が明示されていない |

---

## 2. 各ドキュメントの不足点

| ドキュメント | セキュリティ上の不足点 |
|---|---|
| **01-system-architecture** | SASのアクセス制御、モジュール間通信の認証、Luaスクリプトのインジェクション対策が未記述 |
| **02-llm-integration** | APIキーのローテーション、プロンプトサニタイゼーション、コスト上限設定が未記述 |
| **03-cognitive-controller** | CC入力情報の検証、ブロードキャスト内容の無害性確認が未記述 |
| **04-memory-system** | ベクトルDBのアクセス制御、記憶の完全性検証、エージェント間の記憶分離が未記述 |
| **05-minecraft-platform** | サーバー認証設定、LLM生成コードのサンドボックス実行、チャット入力のサニタイゼーションが未記述 |
| **06-social-cognition** | 感情スコアの入力検証、社会グラフの整合性チェックが未記述 |
| **07-goal-planning** | 目標生成の安全性制約、行動認識NNの敵対的攻撃耐性が未記述 |
| **08-infrastructure** | ネットワークセグメンテーション、TLS通信、サービス間認証が未記述 |
| **09-evaluation** | 評価用LLMプロンプトのインジェクション対策が未記述 |
| **10-devops** | シークレット管理（Vault等）、監査ログ、アクセス制御ポリシーが未記述 |

---

## 3. 推奨対策

### 最優先（Phase 0で対応）

1. **プロンプトサニタイゼーション層の導入**
   - エージェント発話・チャット入力をLLMプロンプトに挿入する前にサニタイズ
   - XMLタグやシステムプロンプト区切り文字のエスケープ
   - 入力長の制限

2. **APIキー管理の強化**
   - **Phase 0 (MVP)**: `.env`ファイル + `python-dotenv`による管理。Docker Composeの`env_file`ディレクティブで環境変数として注入。`.env`ファイルは`.gitignore`に追加し、`.env.example`のみをリポジトリに含める
   - **Phase 1**: Docker Secretsへの移行。`docker secret create`でシークレットを管理し、コンテナ内では`/run/secrets/`から読み取り
   - **Phase 2以降**: HashiCorp Vault または AWS Secrets Managerによる一元管理。キーローテーションの自動化、エージェント/モジュール別のAPIキー分離
   - **全フェーズ共通**: 月次コスト上限の設定とアラート（LLMプロバイダのダッシュボードで設定）

3. **SASアクセス制御**
   - Redis ACLによるエージェント別の読み書き権限設定
   - エージェントIDベースの認証
   - 楽観的ロックのCASトークン検証

### 高優先（Phase 1で対応）

4. **LLM生成コードのサンドボックス実行**
   - Voyager風スキルコードをDockerコンテナ内で実行
   - ファイルシステム・ネットワークアクセスの制限
   - 実行時間制限（タイムアウト）

5. **エージェント暴走防止**
   - LLM API呼び出し回数の上限（エージェント/分、グローバル/分）
   - 同一アクションのループ検出（n-gramベース、3回以上で強制停止）
   - リソース消費監視（CPU、メモリ）とサーキットブレーカー

6. **ネットワークセキュリティ**
   - Redis/PostgreSQL/Qdrant間のTLS通信
   - Minecraftサーバーのプライベートネットワーク配置
   - Kubernetes NetworkPolicyによるPod間通信の制限

### 中優先（Phase 2で対応）

7. **記憶システムの保護**
   - エージェント別のQdrantコレクション分離
   - 記憶の署名検証（改ざん検出）
   - 記憶挿入レートの制限

8. **監査ログ**
   - 全LLM呼び出しのログ記録
   - SAS変更の監査証跡
   - 管理操作のログ

9. **Redis Pub/Subメッセージ認証**
   - メッセージにHMAC署名を付与
   - エージェントIDの検証

---

## 4. 優先対応ランキング

| 順位 | 対策 | リスク | 工数 | 効果 |
|---|---|---|---|---|
| 1 | プロンプトサニタイゼーション | C-1 | 小 | 極大 |
| 2 | APIキー管理+コスト上限 | C-2 | 中 | 極大 |
| 3 | SASアクセス制御 | C-3 | 中 | 大 |
| 4 | エージェント暴走防止 | H-1 | 中 | 大 |
| 5 | コードサンドボックス | H-3 | 大 | 大 |
| 6 | MCサーバー認証 | H-2 | 小 | 中 |
| 7 | TLS通信 | M-3 | 中 | 中 |
| 8 | 記憶システム保護 | H-4 | 大 | 中 |
| 9 | ログアクセス制御 | M-1 | 小 | 小 |
| 10 | 監査ログ | M-2 | 中 | 小 |

---

## 5. セキュリティアーキテクチャの推奨構成

```
┌─────────────────────────────────────────────────┐
│                Security Layer                    │
│  ┌──────────────┐  ┌──────────────────────────┐ │
│  │ Secret Mgmt  │  │ Prompt Sanitizer         │ │
│  │ Phase0: .env │  │ (Input validation layer) │ │
│  │ Phase1: Docker│  │                          │ │
│  │   Secrets    │  │                          │ │
│  │ Phase2: Vault│  │                          │ │
│  └──────┬───────┘  └──────────┬───────────────┘ │
│         │                     │                  │
│  ┌──────▼───────┐  ┌─────────▼────────┐        │
│  │ API Key      │  │ Rate Limiter     │        │
│  │ Rotation     │  │ + Circuit Breaker│        │
│  └──────────────┘  └──────────────────┘        │
│                                                  │
│  ┌──────────────┐  ┌──────────────────┐         │
│  │ Redis ACL    │  │ Code Sandbox     │         │
│  │ (SAS保護)    │  │ (Docker isolate) │         │
│  └──────────────┘  └──────────────────┘         │
│                                                  │
│  ┌──────────────┐  ┌──────────────────┐         │
│  │ Audit Log    │  │ TLS Everywhere   │         │
│  │ (全操作記録)  │  │ (通信暗号化)      │         │
│  └──────────────┘  └──────────────────┘         │
└─────────────────────────────────────────────────┘
```

---

## 6. セキュリティテスト連携マッピング

各セキュリティリスクに対する具体的なテストケースを定義する。review-testingのテスト戦略と連携し、セキュリティリスクがテストでカバーされることを保証する。

### Phase 0で実施すべきセキュリティテスト

| リスク | テストカテゴリ | テスト内容 | テスト手法 | 優先度 |
|---|---|---|---|---|
| C-1: プロンプトインジェクション | Unit | XMLタグ・システムプロンプト区切り文字を含む発話のサニタイズ検証 | 既知のインジェクションパターン100件のテストセット | P0 |
| C-1: プロンプトインジェクション | Integration | エージェントAの悪意ある発話がエージェントBの行動を変化させないことの検証 | 攻撃シナリオテスト（jailbreak、prompt leaking、role switching） | P0 |
| C-2: APIキー漏洩 | Unit | ログ・エラーメッセージにAPIキーが含まれないことの検証 | 正規表現ベースのシークレットスキャン | P0 |
| C-2: APIキー管理 | Unit | コスト上限超過時にLLM呼び出しがブロックされることの検証 | モックAPIでの上限テスト | P0 |
| C-3: SAS無認証アクセス | Integration | 未認証プロセスからのRedis読み書きが拒否されることの検証 | Redis ACLテスト | P1 |
| H-1: エージェント暴走 | Unit | LLM呼び出し回数上限の動作検証 | レート制限のUnit Test | P0 |
| H-1: エージェント暴走 | Integration | 同一アクションのループ検出（n-gram）が正しく発火することの検証 | シミュレーション + 強制ループ注入 | P1 |

### Phase 1で実施すべきセキュリティテスト

| リスク | テストカテゴリ | テスト内容 | テスト手法 | 優先度 |
|---|---|---|---|---|
| H-3: コードインジェクション | Unit | LLM生成コードのサンドボックス脱出テスト | 危険なコード（ファイルアクセス、ネットワーク、プロセス起動）の検出 | P0 |
| H-3: コードインジェクション | Integration | サンドボックス内でのファイルシステム・ネットワーク隔離の検証 | Dockerコンテナ内での攻撃シミュレーション | P1 |
| H-4: 記憶データ汚染 | Unit | エージェント間の記憶分離（他エージェントの記憶への書き込み拒否） | Qdrant ACLテスト | P1 |
| M-3: Pub/Subメッセージ偽装 | Integration | 不正なエージェントIDからのメッセージが拒否されることの検証 | メッセージ認証テスト | P2 |

### 依存関係スキャン（CI/CD統合）

| テスト | 実行頻度 | ツール | 対象 |
|---|---|---|---|
| Python依存関係脆弱性スキャン | 毎PR | Safety / pip-audit | requirements.txt / pyproject.toml |
| Node.js依存関係脆弱性スキャン | 毎PR | npm audit | Mineflayerブリッジの package.json |
| コンテナイメージスキャン | Weekly | Trivy | Docker イメージ |
| シークレットスキャン | 毎コミット | gitleaks / trufflehog | リポジトリ全体 |

---

## 7. まとめ

- **Critical 3件、High 4件、Medium 5件、Low 3件** の計15件のセキュリティリスクを特定
- 最も重要なリスクは**LLMプロンプトインジェクション**（エージェント間の会話経由）
- 調査ドキュメント全体でセキュリティ設計が不足しており、専用のセキュリティ設計書の追加作成を推奨
- Phase 0（MVP段階）でプロンプトサニタイゼーション、APIキー管理、SASアクセス制御の3点を最優先で実装すべき
- **セキュリティテスト連携**: 上記セクション6のテストマッピングに基づき、review-testingのテスト戦略にセキュリティテストを統合すること
