# Project Sid 再現実装ロードマップ

## 概要

本ドキュメントは、Project Sid論文のPIANOアーキテクチャとマルチエージェント文明シミュレーションの再現実装に向けた、フェーズ別ロードマップである。10本の技術調査ドキュメント（01-10）と5本のレビュードキュメント（review-*）の全成果物を統合し、現実的な実装計画を策定した。

---

## 全体タイムライン

```
Month:  1    2    3    4    5    6    7    8    9    10   11   12
        ├────────────┤
        Phase 0: MVP (2-3ヶ月)
                     ├──────────────────┤
                     Phase 1: 基盤完成 (3-4ヶ月)
                                        ├────────────┤
                                        Phase 2: スケーリング (2-3ヶ月)
                                                     ├────────────┤
                                                     Phase 3: 文明実験 (2-3ヶ月)
```

**総開発期間**: 9-13ヶ月 / **総工数**: 30-50人月 / **ピーク人員**: 5人

---

## Phase 0: MVP（最小実行可能構成）

**期間**: 2-3ヶ月 / **人員**: 2-3人 / **予算**: $50-100/月

### 目標
PIANOアーキテクチャの核心的な設計（ステートレスモジュール+共有状態+CC）が実際に動作することを検証する。

### 成果物

| # | 成果物 | 詳細 | 参照Doc |
|---|---|---|---|
| 0-1 | 共有エージェント状態(SAS) | Redis上のSASスキーマ、CRUDオペレーション | 01 |
| 0-2 | モジュールスケジューラ | ティックベースの並列モジュール実行基盤 | 01 |
| 0-3 | 認知コントローラ(CC) MVP | 固定間隔の情報圧縮+同期ブロードキャスト | 03 |
| 0-4 | 記憶システム（WM+STM） | 作業記憶+短期記憶（LTMなし） | 04 |
| 0-5 | スキル実行モジュール | Mineflayer経由の基本操作（移動、採掘、クラフト） | 05 |
| 0-6 | 行動認識（ルールベース） | 期待-実際比較のルールベース実装 | 07 |
| 0-7 | LLMアブストラクション | LiteLLMベースの統一インターフェース | 02 |
| 0-8 | MockLLMProvider | テスト用LLMモック | review-testing |
| 0-9 | Docker Compose開発環境 | MC + Redis + PostgreSQLのローカル環境 | 10 |

### マイルストーン

| Week | マイルストーン | 検証基準 |
|---|---|---|
| W2 | SAS + モジュールスケジューラが動作 | 2つのダミーモジュールが並列で共有状態を読み書き |
| W4 | Mineflayer接続 + スキル実行 | ボットが指示に従い移動・採掘を実行 |
| W6 | CC + 記憶 + 行動認識が統合 | 1体のエージェントがCC制御下で行動 |
| W8 | MVP完成 | 1-5体のエージェントが30分間自律的にアイテム収集 |

### 対応すべきレビュー指摘

- **review-security**: プロンプトサニタイゼーション層の導入（C-1）、APIキー管理（C-2）
- **review-integration**: CC実行間隔の統一（Error）、Python/TypeScript統合方針の決定（Error）
- **review-cost**: GPT-4o-miniでの全モジュール統一（MVP限定）

### リスク

| リスク | 影響 | 緩和策 |
|---|---|---|
| Python-Mineflayerブリッジの不安定性 | 高 | ZMQ/gRPCの早期PoC |
| LLM出力のJSON解析エラー | 中 | 構造化出力（JSON mode）の強制 |
| CCの情報圧縮品質 | 中 | 固定テンプレート方式で開始 |

---

## Phase 1: 基盤完成

**期間**: 3-4ヶ月 / **人員**: 3-5人 / **予算**: $810-1,450/月（10体）

### 目標
全PIANOモジュールを実装し、10体規模で論文のSection 3（単一エージェント進化）とSection 4の小グループ実験を再現する。

### 成果物

| # | 成果物 | 詳細 | 参照Doc |
|---|---|---|---|
| 1-1 | 目標生成モジュール | グラフ構造推論、社会的目標の5-10秒生成 | 07 |
| 1-2 | 計画モジュール | HTN + LLMベースの動的計画 | 07 |
| 1-3 | 社会認識モジュール | 感情追跡(0-10)、好感度推定、選択的起動 | 06 |
| 1-4 | 発話モジュール | CC条件付き言語生成 | 03 |
| 1-5 | 自己省察モジュール | Reflexionベースの3段階プロセス | 07 |
| 1-6 | 長期記憶(LTM) | Qdrant + ベクトル検索 + 記憶圧縮 | 04 |
| 1-7 | 行動認識NN | 小規模ニューラルネット（~100Kパラメータ） | 07 |
| 1-8 | 性格モデリング | Big Fiveベースの性格→行動マッピング | 06 |
| 1-9 | 社会グラフ | NetworkX有向重み付きグラフ | 06 |
| 1-10 | モデルティアリング | Tier1/2/3のモデル分離 | 02 |
| 1-11 | 基本評価パイプライン | アイテム収集ベンチマーク、社会認知精度 | 09 |
| 1-12 | CI/CDパイプライン | lint→unit→integrationの自動化 | 10 |

### マイルストーン

| Week | マイルストーン | 検証基準 |
|---|---|---|
| W4 | 全モジュールのUnit Test通過 | モックLLMで全モジュールが動作 |
| W8 | 10体同時動作 | 10体が同一MC環境で安定動作 |
| W12 | 単一エージェント実験再現 | 30分で平均15-20種のアイテム収集 |
| W14 | 小グループ実験再現 | 感情追跡実験で正確な追跡を確認 |
| W16 | Phase 1完了 | 10体で全モジュールが安定動作し、感情追跡の定性的な正確性を確認 |

### 対応すべきレビュー指摘

- **review-security**: SASアクセス制御（C-3）、エージェント暴走防止（H-1）
- **review-integration**: ベクトルDB統一（Qdrantに確定）、MCサーバー統一（Pufferfishに確定）
- **review-oss**: Voyagerスキルライブラリ設計の参考、Generative Agents記憶設計の参考
- **review-testing**: MockLLMProviderの標準化、CC入出力のスナップショットテスト

---

## Phase 2: スケーリング

**期間**: 2-3ヶ月 / **人員**: 3-4人 / **予算**: $3,710-6,910/月（50体）

### 目標
50-500体規模に対応する分散実行基盤を構築し、Section 4の50体社会実験を再現する。

### 成果物

| # | 成果物 | 詳細 | 参照Doc |
|---|---|---|---|
| 2-1 | Ray分散実行基盤 | エージェントのシャーディング、Worker Node管理 | 01, 08 |
| 2-2 | LLMゲートウェイ | レート制限、キューイング、マルチプロバイダ | 02, 08 |
| 2-3 | Velocity MCプロキシ | 複数MCサーバーの統合 | 05 |
| 2-4 | プロンプトキャッシング | OpenAI/Anthropicネイティブキャッシュ | 02 |
| 2-5 | 分散ロギング | Grafana Loki + OpenTelemetryトレーシング | 10 |
| 2-6 | モニタリング | Prometheus + Grafanaダッシュボード | 08, 10 |
| 2-7 | Kubernetes構成 | 3ノードプール（general/agent/gpu） | 10 |
| 2-8 | 集合知メカニズム | 観察者閾値ベースの精度向上 | 06 |
| 2-9 | インフルエンサー機構 | 感情伝播、投票行動への影響 | 06 |
| 2-10 | 高度な評価パイプライン | 役割エントロピー、税遵守率、ミーム検出 | 09 |

### マイルストーン

| Week | マイルストーン | 検証基準 |
|---|---|---|
| W4 | 50体の分散実行 | 50体が安定動作（TPS>15） |
| W6 | 50体社会実験再現 | 社会認知精度 r>0.7（Phase 1から移動）、集合知効果の確認 |
| W8 | 500体のスモークテスト | 500体が10分間安定動作 |
| W10 | モニタリング完成 | 全メトリクスがダッシュボードに表示 |
| W12 | Phase 2完了 | 500体で4時間の安定実行 |

### 対応すべきレビュー指摘

- **review-security**: TLS通信（M-3）、ネットワークセグメンテーション
- **review-cost**: ローカルモデル導入（Tier2/3のLlama置換）によるコスト削減
- **review-testing**: スケーリング負荷テスト、パフォーマンス回帰テスト
- **review-integration**: NetworkXスケーラビリティ対策（500体以上でnx→igraph移行検討）

---

## Phase 3: 文明実験

**期間**: 2-3ヶ月 / **人員**: 2-3人 / **予算**: $25,400-46,200/月（500体）

### 目標
500-1000体規模でSection 5の文明実験（専門化、集団ルール、文化ミーム、宗教伝播）を再現する。

### 成果物

| # | 成果物 | 詳細 | 参照Doc |
|---|---|---|---|
| 3-1 | 専門化システム | 自発的役割分化、GPT-4o役割推論パイプライン | 05, 09 |
| 3-2 | 集団ルールシステム | 憲法、税制、民主的投票プロセス | 09 |
| 3-3 | 文化ミーム追跡 | LLMミーム分析、地理的伝播ヒートマップ | 09 |
| 3-4 | 宗教伝播システム | パスタファリアン司祭、SIRモデルフィッティング | 09 |
| 3-5 | 1000体対応 | マルチノードクラスター、水平スケーリング | 08 |
| 3-6 | 実験結果ダッシュボード | Streamlit分析ダッシュボード | 09 |
| 3-7 | 人間評価プロトコル | LLM評価vs人間評価の比較検証 | 09 |

### マイルストーン

| Week | マイルストーン | 検証基準 |
|---|---|---|
| W3 | 専門化実験再現 | 30体で6種以上の役割分化 |
| W5 | 集団ルール実験再現 | 反税条件で税率低下を確認 |
| W7 | 500体文化ミーム実験 | 町ごとの固有ミームパターン |
| W9 | 500体宗教伝播実験 | 飽和なしの継続的改宗増加 |
| W12 | Phase 3完了 | 全論文実験の再現完了 |

---

## 障害復旧・チェックポイント設計

長時間シミュレーション（4時間以上）の安定実行には、障害復旧の仕組みが不可欠である。各フェーズに以下の設計を組み込む。

### Phase別の障害復旧対応

| フェーズ | 対応内容 | 成果物 |
|---|---|---|
| **Phase 0** | 基本的なチェックポイント/リスタート機構。SASスナップショットの定期保存（5分間隔）。エージェントクラッシュ時の自動再起動 | `CheckpointManager` 基本実装 |
| **Phase 1** | Redis RDB/AOF永続化設定。Qdrantコレクションスナップショット。エージェント状態のチェックポイントからの復元テスト | バックアップ設定、復元テストスイート |
| **Phase 2** | Redis Clusterのフェイルオーバー設定。分散チェックポイントの協調（全エージェントの一貫性あるスナップショット）。PostgreSQL WALベースのPITR | 分散バックアップ基盤 |
| **Phase 3** | 1000体規模での部分障害からの復旧。リージョン別チェックポイント。シミュレーション中断からの透過的な再開 | 本番障害復旧手順書 |

### チェックポイント設計の要件

- **チェックポイント間隔**: 5分（Phase 0-1）、1分（Phase 2-3）
- **チェックポイントデータ**: SAS全セクション + STM + 社会グラフ + エージェントメタデータ
- **復元時間目標**: 2分以内（Phase 0-1）、5分以内（Phase 2-3、500体規模）
- **データ整合性**: チェックポイント取得時はCCサイクル間で実施し、モジュール実行中のスナップショットを回避

---

## クリティカルパス

```
SAS設計 → モジュールスケジューラ → CC MVP → 全モジュール統合 → 10体テスト
    ↓                                                              ↓
Mineflayerブリッジ → スキル実行 ─────────────────────────────→ アイテム収集ベンチマーク
                                                                   ↓
                                                        Ray分散基盤 → 50体テスト → 500体テスト
                                                                              ↓
                                                                    文明実験 → 論文再現完了
```

**最大のボトルネック**:
1. **LLM API呼び出しのレート制限** — 500体で~217 calls/s。複数プロバイダの分散が必須
2. **Python-Mineflayerブリッジの性能** — 1000体のボット制御を安定処理
3. **CCの情報圧縮品質** — ブロードキャストの質がエージェント行動の一貫性を決定

---

## 技術選定サマリー

| カテゴリ | 選定 | 代替案 | 決定根拠 |
|---|---|---|---|
| 主言語 | Python 3.12+ | TypeScript | エコシステム（ML/NN/Ray）の充実 |
| MCブリッジ | TypeScript (Mineflayer) | - | 唯一の選択肢 |
| 共有状態 | Redis 7+ | etcd | Pub/Sub + Lua scripting |
| 分散実行 | Ray 2.x | Celery | Actor model、Python native |
| ベクトルDB | Qdrant | Chroma | スケーラビリティ、バイナリ量子化 |
| 永続化 | PostgreSQL 16 | MySQL | asyncpg、高信頼性 |
| LLM抽象化 | LiteLLM | 独自実装 | マルチプロバイダ即座対応 |
| 監視 | Prometheus + Grafana | Datadog | OSS、コスト |
| ログ | Grafana Loki | ELK | 軽量、コスト効率 |
| 実験管理 | MLflow + Hydra | W&B | OSS、柔軟性 |
| CI/CD | GitHub Actions | GitLab CI | エコシステム統合 |
| コンテナ | Docker + K8s | Docker Compose | 本番スケーラビリティ |
| MCサーバー | Pufferfish + Velocity | Paper | 最高性能 |

---

## コストサマリー

> **注**: 2026年2月時点のAPI価格に基づく。詳細はreview-cost.mdを参照。

| フェーズ | スケール | LLM/月 | インフラ/月 | 合計/月 |
|---|---|---|---|---|
| Phase 0 | 1-5体 | $50-100 | $0（ローカル） | **$50-100** |
| Phase 1 | 10体 | $640-1,280 | $170 | **$810-1,450** |
| Phase 2 | 50体 | $3,200-6,400 | $510 | **$3,710-6,910** |
| Phase 3 | 500体 | $20,800-41,600 | $4,600 | **$25,400-46,200** |
| Phase 3+ | 1,000体 | $36,800-73,600 | $9,200 | **$46,000-82,800** |

**インフラ+LLM APIコスト概算**: $80,000-190,000（12ヶ月）
**人件費を含む総プロジェクトコスト概算**: 3,760-8,490万円（12ヶ月、review-cost.md セクション3.2参照）

---

## レビュー指摘の統合対応表

| 指摘元 | 重要指摘 | 対応フェーズ |
|---|---|---|
| review-integration | コード言語混在（TS/Python） | Phase 0で方針確定 |
| review-integration | CC実行間隔の矛盾 | Phase 0で統一 |
| review-security | プロンプトインジェクション対策 | Phase 0 |
| review-security | APIキー管理 | Phase 0 |
| review-cost | LLMコスト最適化（モデルティアリング） | Phase 0-1 |
| review-cost | ローカルモデル導入 | Phase 1-2 |
| review-oss | Voyagerスキルライブラリ参考 | Phase 0-1 |
| review-testing | MockLLMProvider標準化 | Phase 0 |
| review-testing | パフォーマンス回帰テスト | Phase 2 |
| review-integration | ベクトルDB統一（Qdrant） | Phase 1 |
| review-integration | MCサーバー統一（Pufferfish） | Phase 0 |

---

## リスク管理

| リスク | 影響度 | 発生確率 | 緩和策 | 担当フェーズ |
|---|---|---|---|---|
| LLM APIコストの超過 | 高 | 高 | モデルティアリング、ローカルモデル、コスト上限アラート | 全フェーズ |
| Python-Mineflayerブリッジの不安定性 | 高 | 中 | 早期PoC、ZMQ/gRPCの比較検証 | Phase 0 |
| CCの情報圧縮品質不足 | 高 | 中 | ゴールデンファイルテスト、人間評価との比較 | Phase 1 |
| 1000体でのサーバー容量制約 | 中 | 高 | Velocity分散、空間シャーディング | Phase 2-3 |
| LLM出力の非決定性による再現困難 | 中 | 高 | temperature=0、キャッシュ、統計的再現 | 全フェーズ |
| 論文の未記載パラメータ | 中 | 確実 | 感度分析、パラメータスイープ | Phase 1-3 |

---

## 成功基準

| フェーズ | 成功基準 |
|---|---|
| Phase 0 | 1-5体が30分間安定動作、CCによる言行一致の改善を確認 |
| Phase 1 | 30分で平均15-20種のアイテム、10体で全モジュール安定動作、感情追跡の定性的確認 |
| Phase 2 | 500体が4時間安定動作、50体で集合知効果を確認 |
| Phase 3 | 6種以上の役割分化、税率変動、文化ミーム・宗教伝播の再現 |
